/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var R=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var F=Object.prototype.hasOwnProperty;var V=(l,t)=>{for(var e in t)R(l,e,{get:t[e],enumerable:!0})},K=(l,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of B(t))!F.call(l,i)&&i!==e&&R(l,i,{get:()=>t[i],enumerable:!(n=G(t,i))||n.enumerable});return l};var j=l=>K(R({},"__esModule",{value:!0}),l);var Z={};V(Z,{default:()=>N});module.exports=j(Z);var T=require("obsidian");var U={clientId:"",accessToken:"",refreshToken:"",tokenExpiry:"unlimited",tokenExpiryDate:void 0,timeRange:90},I={"1week":"1 week","1month":"1 month","3months":"3 months","6months":"6 months",unlimited:"Unlimited (until manually disconnected)"},v="https://rajeevrajchal.github.io/pmc-google/oauth-callback",x="https://obsdian-pmc-be.vercel.app";var P=require("obsidian");var y=class{static initiateOAuthFlow(t){if(!t||t.trim()===""){new P.Notice("Please configure client ID first");return}let e=this.buildAuthUrl(t);new P.Notice("Opening google authentication in browser"),window.open(e,"_blank")}static buildAuthUrl(t){let e=new URLSearchParams({client_id:t,redirect_uri:v,response_type:"code",scope:this.SCOPES.join(" "),access_type:"offline",prompt:"consent"});return`${this.OAUTH_URL}?${e.toString()}`}static disconnect(){new P.Notice("Disconnected from google calendar")}};y.OAUTH_URL="https://accounts.google.com/o/oauth2/v2/auth",y.SCOPES=["https://www.googleapis.com/auth/calendar.readonly","https://www.googleapis.com/auth/calendar.events"];var d=require("obsidian");var M=require("obsidian");var D=class{static async refreshAccessToken(t,e){try{return(await(0,M.requestUrl)({url:`${x}/api/refresh`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:e})})).json}catch(n){throw console.error("Token refresh failed:",n),new Error("Failed to refresh access token")}}static isTokenExpired(t){return t?Date.now()>=t:!1}static isTokenExpiringSoon(t,e=5){if(!t)return!1;let n=e*60*1e3;return Date.now()>=t-n}};var m=class{static async ensureValidToken(t){let{settings:e}=t;if(!e.accessToken)throw new Error("No access token available. Please connect to google calendar in settings.");if(e.tokenExpiryDate&&Date.now()>=e.tokenExpiryDate)if(e.refreshToken)try{let n=await D.refreshAccessToken(e.clientId,e.refreshToken);e.accessToken=n.access_token,e.tokenExpiryDate=Date.now()+n.expires_in*1e3,await t.saveSettings()}catch(n){throw console.error("Token refresh failed:",n),new Error("Token expired and refresh failed. Please reconnect to google calendar in settings.")}else throw new Error("Token expired and no refresh token available. Please reconnect to google calendar in settings.");return e.accessToken}static async fetchEvents(t,e="primary",n,i,s,a=250){try{let r=await this.ensureValidToken(t),o={singleEvents:"true",orderBy:"startTime",maxResults:a.toString()};i&&(o.timeMin=i),s&&(o.timeMax=s),n!=null&&n.trim()&&(o.q=n);let c=new URLSearchParams(o).toString();return(await(0,d.requestUrl)({url:`${this.BASE_URL}/calendars/${e}/events?${c}`,method:"GET",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}})).json.items||[]}catch(r){throw console.error("Error fetching calendar events:",r),new d.Notice("Failed to fetch calendar events"),r}}static async createEvent(t,e,n="primary"){try{let i=await this.ensureValidToken(t),a=(await(0,d.requestUrl)({url:`${this.BASE_URL}/calendars/${n}/events`,method:"POST",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"},body:JSON.stringify(e)})).json;return new d.Notice("Event created successfully"),a}catch(i){throw console.error("Error creating calendar event:",i),new d.Notice("Failed to create calendar event"),i}}static async updateEvent(t,e,n,i="primary"){try{let s=await this.ensureValidToken(t),r=(await(0,d.requestUrl)({url:`${this.BASE_URL}/calendars/${i}/events/${e}`,method:"PUT",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"},body:JSON.stringify(n)})).json;return new d.Notice("Event updated successfully"),r}catch(s){throw console.error("Error updating calendar event:",s),new d.Notice("Failed to update calendar event"),s}}static async deleteEvent(t,e,n="primary"){try{let i=await this.ensureValidToken(t);await(0,d.requestUrl)({url:`${this.BASE_URL}/calendars/${n}/events/${e}`,method:"DELETE",headers:{Authorization:`Bearer ${i}`}}),new d.Notice("Event deleted successfully")}catch(i){throw console.error("Error deleting calendar event:",i),new d.Notice("Failed to delete calendar event"),i}}static async listCalendars(t){try{let e=await this.ensureValidToken(t);return(await(0,d.requestUrl)({url:`${this.BASE_URL}/users/me/calendarList`,method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}})).json.items||[]}catch(e){throw console.error("Error fetching calendars:",e),new d.Notice("Failed to fetch calendars"),e}}static async syncCalendar(t){try{await this.ensureValidToken(t),new d.Notice("Syncing calendar");let e=new Date().toISOString(),n=new Date(Date.now()+30*24*60*60*1e3).toISOString(),i=await this.fetchEvents(t,"primary",void 0,e,n);new d.Notice(`Synced ${i.length} events`);return}catch(e){throw console.error("Error syncing calendar:",e),new d.Notice("Failed to sync calendar"),e}}};m.BASE_URL="https://www.googleapis.com/calendar/v3";var f=require("obsidian");var h=class{static calculateExpiryDate(t){if(t==="unlimited")return;let e=Date.now(),n=24*60*60*1e3;switch(t){case"1week":return e+7*n;case"1month":return e+30*n;case"3months":return e+90*n;case"6months":return e+180*n;default:return}}static isTokenExpired(t){return t?Date.now()>=t:!1}static getTimeRemaining(t){if(!t)return"Unlimited";let e=t-Date.now();if(e<=0)return"Expired";let n=Math.floor(e/(24*60*60*1e3)),i=Math.floor(e%(24*60*60*1e3)/(60*60*1e3)),s=Math.floor(e%(60*60*1e3)/(60*1e3));return n>0?`${n} day${n!==1?"s":""}`:i>0?`${i} hour${i!==1?"s":""}`:`${s} minute${s!==1?"s":""}`}static needsRefreshSoon(t){if(!t)return!1;let e=24*60*60*1e3,n=t-Date.now();return n>0&&n<e}static formatExpiryDate(t){return t?new Date(t).toLocaleDateString(void 0,{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Never"}};var p=class{static renderCallbackUrlSetting(t){new f.Setting(t).setName("Callback URL").addText(e=>e.setValue(v).setDisabled(!0)).addButton(e=>e.setButtonText("Copy").onClick(async()=>{await navigator.clipboard.writeText(v),new f.Notice("Callback url copied to clipboard")}))}static renderClientIdSetting(t,e,n){new f.Setting(t).setName("Client ID").addText(i=>i.setPlaceholder("123456789-abcdefg.apps.googleusercontent.com").setValue(e).onChange(async s=>{let a=s.trim();await n(a)}))}static renderTokenExpirySetting(t,e,n){new f.Setting(t).setName("Token expiry").setDesc("How long before the access token expires and requires re-authentication").addDropdown(i=>{Object.entries(I).forEach(([s,a])=>{i.addOption(s,a)}),i.setValue(e).onChange(async s=>{await n(s)})})}static renderTokenStatus(t,e){let n=h.getTimeRemaining(e),i=h.isTokenExpired(e),s=h.needsRefreshSoon(e),a;e?i?a="Token expired":s?a=`Token expires in ${n}`:a=`Token valid for ${n}`:a="Token valid: unlimited",new f.Setting(t).setName("Token status").setDesc(a)}static renderAccountSetting(t,e,n,i,s,a){let r=new f.Setting(t).setName("Account").setDesc(e?"Connected":"Not connected");e?(r.addButton(o=>o.setButtonText("Sync calendar").onClick(async()=>{await a()})),r.addButton(o=>o.setWarning().setButtonText("Disconnect").onClick(async()=>{await s()}))):!n||n===""?r.setDesc("Please set client ID first"):r.addButton(o=>o.setCta().setButtonText("Connect to google").onClick(()=>{i(n)}))}};var $={...U},A=class extends T.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),new T.Setting(t).setName("Pick calendar event").setHeading();let e=t.createDiv({cls:"pmc-intro-section"});new T.Setting(e).setName("How to use").setHeading();let n=e.createEl("ul",{cls:"pmc-usage-list"}),i=n.createEl("li");i.appendText("Type "),i.createEl("code",{text:":"}),i.appendText(" in your note to trigger the calendar event picker");let s=n.createEl("li");s.appendText("Type "),s.createEl("code",{text:":meeting"}),s.appendText(" to search and filter events containing 'meeting'"),n.createEl("li").appendText("Select an event from the list to insert it as a link in your note");let r=n.createEl("li");r.appendText("Choose "),r.createEl("strong",{text:"Create new event"}),r.appendText(" to create a new calendar event"),new T.Setting(t).setName("Setup and configuration").setHeading(),p.renderCallbackUrlSetting(t),p.renderClientIdSetting(t,this.plugin.settings.clientId,async o=>{this.plugin.settings.clientId=o,await this.plugin.saveSettings(),this.display()}),p.renderTokenExpirySetting(t,this.plugin.settings.tokenExpiry,async o=>{this.plugin.settings.tokenExpiry=o,this.plugin.settings.tokenExpiryDate=h.calculateExpiryDate(o),await this.plugin.saveSettings(),this.display()}),new T.Setting(t).setName("Suggestion time range").setDesc('Time duration to fetch calendar events for suggestions (e.g., "90 days"). Events from this many days in the past and future will be considered.').addText(o=>o.setPlaceholder("90 days").setValue(String(this.plugin.settings.timeRange)).onChange(async c=>{this.plugin.settings.timeRange=Number(c),await this.plugin.saveSettings()})),this.plugin.settings.accessToken&&p.renderTokenStatus(t,this.plugin.settings.tokenExpiryDate),p.renderAccountSetting(t,!!this.plugin.settings.accessToken,this.plugin.settings.clientId,o=>{y.initiateOAuthFlow(o)},async()=>{this.plugin.settings.accessToken="",this.plugin.settings.refreshToken="",this.plugin.settings.tokenExpiryDate=void 0,await this.plugin.saveSettings(),this.display(),y.disconnect()},async()=>{try{await m.syncCalendar(this.plugin)}catch(o){console.error("Sync failed:",o),new T.Notice("Please check your connection to google calendar")}})}};var S=require("obsidian");var k=require("obsidian");var w=class{static async deriveKey(t,e){let n=new TextEncoder,i=await crypto.subtle.importKey("raw",n.encode(t),{name:"PBKDF2"},!1,["deriveKey"]);return await crypto.subtle.deriveKey({name:"PBKDF2",salt:e,iterations:1e5,hash:"SHA-256"},i,{name:this.ALGORITHM,length:this.KEY_LENGTH},!1,["encrypt","decrypt"])}static getVaultPassphrase(t){return`${t}-pmc-plugin-secret-v1`}static async encrypt(t,e){if(!t)return"";try{let n=crypto.getRandomValues(new Uint8Array(this.SALT_LENGTH)),i=crypto.getRandomValues(new Uint8Array(this.IV_LENGTH)),s=this.getVaultPassphrase(e),a=await this.deriveKey(s,n),o=new TextEncoder().encode(t),c=await crypto.subtle.encrypt({name:this.ALGORITHM,iv:i},a,o),u=new Uint8Array(n.length+i.length+c.byteLength);return u.set(n,0),u.set(i,n.length),u.set(new Uint8Array(c),n.length+i.length),this.arrayBufferToBase64(u)}catch(n){throw console.error("Encryption error:",n),new Error("Failed to encrypt data")}}static async decrypt(t,e){if(!t)return"";try{let n=this.base64ToArrayBuffer(t),i=n.slice(0,this.SALT_LENGTH),s=n.slice(this.SALT_LENGTH,this.SALT_LENGTH+this.IV_LENGTH),a=n.slice(this.SALT_LENGTH+this.IV_LENGTH),r=this.getVaultPassphrase(e),o=await this.deriveKey(r,i),c=await crypto.subtle.decrypt({name:this.ALGORITHM,iv:s},o,a);return new TextDecoder().decode(c)}catch(n){throw console.error("Decryption error:",n),new Error("Failed to decrypt data")}}static arrayBufferToBase64(t){let e="",n=t.byteLength;for(let i=0;i<n;i++){let s=t[i];s!==void 0&&(e+=String.fromCharCode(s))}return btoa(e)}static base64ToArrayBuffer(t){let e=atob(t),n=e.length,i=new Uint8Array(n);for(let s=0;s<n;s++)i[s]=e.charCodeAt(s);return i}static isEncrypted(t){if(!t)return!1;let e=Math.ceil((this.SALT_LENGTH+this.IV_LENGTH+16)*4/3),n=/^[A-Za-z0-9+/]+=*$/;return t.length>=e&&n.test(t)}};w.ALGORITHM="AES-GCM",w.KEY_LENGTH=256,w.IV_LENGTH=12,w.SALT_LENGTH=16;var g=require("obsidian");var L=class extends g.Modal{constructor(t,e,n,i){super(t),this.plugin=e,this.initialTitle=n,this.onSubmit=i,this.title=n||"",this.isAllDay=!1,this.description="";let s=new Date;this.date=s.toISOString().split("T")[0]||"";let a=(s.getHours()+1)%24,r=(s.getHours()+2)%24;this.startTime=`${String(a).padStart(2,"0")}:00`,this.endTime=`${String(r).padStart(2,"0")}:00`}onOpen(){let{contentEl:t}=this;t.empty(),new g.Setting(t).setName("Create calendar event").setHeading(),new g.Setting(t).setName("Event title").setDesc("Name of the event").addText(r=>r.setPlaceholder("Team meeting").setValue(this.title).onChange(o=>{this.title=o})),new g.Setting(t).setName("Date").setDesc("Date of the event").addText(r=>{r.setPlaceholder("Select date").setValue(this.date).onChange(o=>{this.date=o}),r.inputEl.type="date"}),new g.Setting(t).setName("All-day event").setDesc("Toggle for all-day events").addToggle(r=>r.setValue(this.isAllDay).onChange(o=>{this.isAllDay=o,t.querySelectorAll(".time-setting").forEach(u=>{o?u.addClass("is-hidden"):u.removeClass("is-hidden")})})),new g.Setting(t).setName("Start time").setDesc("Event start time").addText(r=>{r.setPlaceholder("09:00").setValue(this.startTime).onChange(o=>{this.startTime=o}),r.inputEl.type="time"}).settingEl.addClass("time-setting"),new g.Setting(t).setName("End time").setDesc("Event end time").addText(r=>{r.setPlaceholder("10:00").setValue(this.endTime).onChange(o=>{this.endTime=o}),r.inputEl.type="time"}).settingEl.addClass("time-setting"),new g.Setting(t).setName("Description").setDesc("Additional details (optional)").addTextArea(r=>{r.setPlaceholder("Meeting agenda, notes, etc.").setValue(this.description).onChange(o=>{this.description=o}),r.inputEl.rows=4});let i=t.createDiv({cls:"modal-button-container"});i.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{this.close()}),i.createEl("button",{text:"Create event",cls:"mod-cta"}).addEventListener("click",()=>{this.createEvent()})}async createEvent(){if(!this.title.trim()){new g.Notice("Event title is required");return}if(!this.date){new g.Notice("Event date is required");return}if(!this.isAllDay&&(!this.startTime||!this.endTime)){new g.Notice("Start and end times are required");return}if(!this.plugin.settings.accessToken){new g.Notice("Not authenticated, please connect your google account in settings");return}if(h.isTokenExpired(this.plugin.settings.tokenExpiryDate)){new g.Notice("Access token has expired, please reconnect your google account in settings");return}try{let t={summary:this.title.trim(),description:this.description.trim()||void 0};if(this.isAllDay)t.start={date:this.date,timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone},t.end={date:this.date,timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone};else{let i=`${this.date}T${this.startTime}:00`,s=`${this.date}T${this.endTime}:00`;t.start={dateTime:i,timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone},t.end={dateTime:s,timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone}}let e=await m.createEvent(this.plugin,t,"primary"),n=e.htmlLink||`https://calendar.google.com/calendar/event?eid=${encodeURIComponent(e.id)}`;new g.Notice(`Event "${this.title}" created successfully`),this.onSubmit({title:this.title,link:n}),this.close()}catch(t){let e=t instanceof Error?t.message:"Unknown error";new g.Notice(`Failed to create event: ${e}`)}}onClose(){let{contentEl:t}=this;t.empty()}};var b=class extends k.EditorSuggest{constructor(e,n){super(e);this.cachedEvents=[];this.lastFetchTime=0;this.CACHE_DURATION=5*60*1e3;this.plugin=n}onTrigger(e,n,i){let r=n.getLine(e.line).substring(0,e.ch).match(/:([\w\s]*)$/);if(r){let o=r[1]||"",c=e.ch-r[0].length+1;return{start:{line:e.line,ch:c},end:e,query:o}}return null}async fetchEventsWithCache(e){let n=Date.now();if(n-this.lastFetchTime>this.CACHE_DURATION||this.cachedEvents.length===0)try{let s=new Date(Date.now()-864e5).toISOString(),a=new Date(Date.now()+this.plugin.settings.timeRange*24*60*60*1e3).toISOString();this.cachedEvents=await m.fetchEvents(this.plugin,"primary",void 0,s,a,250),this.lastFetchTime=n}catch(s){return new k.Notice(s instanceof Error?s.message:"Failed to fetch events"),[]}return this.cachedEvents}filterEvents(e,n){if(!n||n.trim()==="")return e;let i=n.toLowerCase().trim();return e.filter(s=>{var a,r,o,c;return!!((a=s.summary)!=null&&a.toLowerCase().includes(i)||(r=s.description)!=null&&r.toLowerCase().includes(i)||(o=s.location)!=null&&o.toLowerCase().includes(i)||(c=s.attendees)!=null&&c.some(u=>{var C,E;return((C=u.email)==null?void 0:C.toLowerCase().includes(i))||((E=u.displayName)==null?void 0:E.toLowerCase().includes(i))}))})}async getSuggestions(e){if(this.plugin.settings.accessToken==="")return new k.Notice("Please connect to google calendar first"),[];let n=(e.query||"").trim();try{let i=await this.fetchEventsWithCache(),s=this.filterEvents(i,n),a=[];return a.push(...s.map(r=>({event:r,summary:r.summary||r.description||"Untitled event"}))),[{isCreate:!0,summary:"Create new event"},...a]}catch(i){return new k.Notice(i instanceof Error?i.message:"Failed to create events"),[]}}renderSuggestion(e,n){n.empty();let i=n.createDiv({cls:"gcal-suggestion-container"});if(e.isCreate)i.addClass("create-new"),i.createEl("span",{text:e.summary});else if(e.event){let s=e.event,a=i.createDiv({cls:"gcal-suggestion-left"});a.createEl("div",{text:s.summary||"Untitled event",cls:"gcal-event-title"}),s.location&&a.createEl("div",{text:s.location,cls:"gcal-event-location"});let r=i.createDiv({cls:"gcal-suggestion-right"});try{let o=new Date(s.start.dateTime||s.start.date||""),c=new Date,u=o.toDateString()===c.toDateString(),C=o.toDateString()===new Date(c.getTime()+864e5).toDateString(),E="";u?E="Today":C?E="Tomorrow":E=o.toLocaleDateString([],{month:"short",day:"numeric",year:o.getFullYear()!==c.getFullYear()?"numeric":void 0});let _="";s.start.dateTime?_=o.toLocaleTimeString([],{hour:"numeric",minute:"2-digit",hour12:!0}):_="All day",r.createEl("div",{text:E,cls:"gcal-event-date"}),r.createEl("div",{text:_,cls:"gcal-event-time"}),(s.hangoutLink||s.conferenceData)&&r.createEl("div",{text:"Video",cls:"gcal-event-conference"})}catch(o){console.error("Error formatting date:",o),r.createEl("small",{text:"Invalid date",attr:{style:"color: var(--text-error);"}})}}}selectSuggestion(e,n){if(!this.context){console.error("No context available");return}if(e.isCreate){let i=this.context.editor,s={...this.context.start},a={...this.context.end},r=this.context.query;new L(this.app,this.plugin,r,o=>{let c=`[${o.title}](${o.link})`;i.replaceRange(c,s,a),this.clearCache()}).open()}else if(e.event){let i=e.event,s=i.htmlLink||`https://calendar.google.com/calendar/event?eid=${encodeURIComponent(i.id)}`,r=`[${i.summary||"Untitled Event"}](${s})`;this.context.editor.replaceRange(r,this.context.start,this.context.end)}}clearCache(){this.cachedEvents=[],this.lastFetchTime=0}};var H=require("obsidian");var O=class{static async exchangeCodeForTokens(t,e){try{return(await(0,H.requestUrl)({url:`${x}/api/exchange`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:e,redirectUri:v})})).json}catch(n){throw console.error("Token exchange failed:",n),new Error("Failed to exchange authorization code for tokens")}}};var N=class extends S.Plugin{constructor(){super(...arguments);this.settingTab=null;this.editorSuggestion=null}async onload(){await this.loadSettings(),this.settingTab=new A(this.app,this),this.addSettingTab(this.settingTab),this.registerObsidianProtocolHandler("pick-meeting-token",async e=>{var i;let n=e.code;if(n)try{new S.Notice("Exchanging code for tokens...");let s=await O.exchangeCodeForTokens(this.settings.clientId,n);this.settings.accessToken=s.access_token,this.settings.refreshToken=s.refresh_token||"";let a=s.expires_in||3600;this.settings.tokenExpiryDate=Date.now()+a*1e3,await this.saveSettings(),(i=this.settingTab)==null||i.display(),new S.Notice("Google calendar connected with long-lasting tokens")}catch(s){console.error("Failed to exchange code:",s),new S.Notice("Failed to complete authentication")}else new S.Notice("Connection failed: no code received")}),this.editorSuggestion=new b(this.app,this),this.registerEditorSuggest(this.editorSuggestion)}onunload(){}async loadSettings(){this.settings=Object.assign({},$,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
