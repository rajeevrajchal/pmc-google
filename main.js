/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var O=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var U=Object.getOwnPropertyNames;var G=Object.prototype.hasOwnProperty;var $=(p,e)=>{for(var t in e)O(p,t,{get:e[t],enumerable:!0})},H=(p,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of U(e))!G.call(p,i)&&i!==t&&O(p,i,{get:()=>e[i],enumerable:!(n=M(e,i))||n.enumerable});return p};var F=p=>H(O({},"__esModule",{value:!0}),p);var B={};$(B,{default:()=>A});module.exports=F(B);var w=require("obsidian");var I={clientId:"",accessToken:"",tokenExpiry:"unlimited",tokenExpiryDate:void 0,timeRange:90},R={"1week":"1 week","1month":"1 month","3months":"3 months","6months":"6 months",unlimited:"Unlimited (until manually disconnected)"},C="https://rajeevrajchal.github.io/pmc-google/oauth-callback";var k=require("obsidian");var E=class{static initiateOAuthFlow(e){if(!e||e.trim()===""){new k.Notice("Please configure client ID first");return}let t=this.buildAuthUrl(e);new k.Notice("Opening google authentication"),window.open(t,"_blank")}static buildAuthUrl(e){let t=new URLSearchParams({client_id:e,redirect_uri:C,response_type:"token",scope:this.SCOPES.join(" "),access_type:"online"});return`${this.OAUTH_URL}?${t.toString()}`}static disconnect(){new k.Notice("Disconnected from google calendar")}};E.OAUTH_URL="https://accounts.google.com/o/oauth2/v2/auth",E.SCOPES=["https://www.googleapis.com/auth/calendar.readonly","https://www.googleapis.com/auth/calendar.events"];var c=require("obsidian");var d=class{static calculateExpiryDate(e){if(e==="unlimited")return;let t=Date.now(),n=24*60*60*1e3;switch(e){case"1week":return t+7*n;case"1month":return t+30*n;case"3months":return t+90*n;case"6months":return t+180*n;default:return}}static isTokenExpired(e){return e?Date.now()>=e:!1}static getTimeRemaining(e){if(!e)return"Unlimited";let t=e-Date.now();if(t<=0)return"Expired";let n=Math.floor(t/(24*60*60*1e3)),i=Math.floor(t%(24*60*60*1e3)/(60*60*1e3)),r=Math.floor(t%(60*60*1e3)/(60*1e3));return n>0?`${n} day${n!==1?"s":""}`:i>0?`${i} hour${i!==1?"s":""}`:`${r} minute${r!==1?"s":""}`}static needsRefreshSoon(e){if(!e)return!1;let t=24*60*60*1e3,n=e-Date.now();return n>0&&n<t}static formatExpiryDate(e){return e?new Date(e).toLocaleDateString(void 0,{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Never"}};var m=class{static async fetchEvents(e,t="primary",n,i,r,o=250,s){try{if(d.isTokenExpired(s))throw new c.Notice("Google calendar token has expired, please reconnect in settings"),new Error("Token expired");let a={singleEvents:"true",orderBy:"startTime",maxResults:o.toString()};i&&(a.timeMin=i),r&&(a.timeMax=r),n&&n.trim()!==""&&(a.q=n);let l=new URLSearchParams(a).toString();return(await(0,c.requestUrl)({url:`${this.BASE_URL}/calendars/${t}/events?${l}`,method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}})).json.items||[]}catch(a){throw console.error("Error fetching calendar events:",a),new c.Notice("Failed to fetch calendar events"),a}}static async createEvent(e,t,n="primary",i){try{if(d.isTokenExpired(i))throw new c.Notice("Google calendar token has expired, please reconnect in settings"),new Error("Token expired");let o=(await(0,c.requestUrl)({url:`${this.BASE_URL}/calendars/${n}/events`,method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(t)})).json;return new c.Notice("Event created successfully"),o}catch(r){throw console.error("Error creating calendar event:",r),new c.Notice("Failed to create calendar event"),r}}static async updateEvent(e,t,n,i="primary",r){try{if(d.isTokenExpired(r))throw new c.Notice("Google calendar token has expired, please reconnect in settings"),new Error("Token expired");let s=(await(0,c.requestUrl)({url:`${this.BASE_URL}/calendars/${i}/events/${t}`,method:"PUT",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(n)})).json;return new c.Notice("Event updated successfully"),s}catch(o){throw console.error("Error updating calendar event:",o),new c.Notice("Failed to update calendar event"),o}}static async deleteEvent(e,t,n="primary",i){try{if(d.isTokenExpired(i))throw new c.Notice("Google calendar token has expired, please reconnect in settings"),new Error("Token expired");await(0,c.requestUrl)({url:`${this.BASE_URL}/calendars/${n}/events/${t}`,method:"DELETE",headers:{Authorization:`Bearer ${e}`}}),new c.Notice("Event deleted successfully")}catch(r){throw console.error("Error deleting calendar event:",r),new c.Notice("Failed to delete calendar event"),r}}static async listCalendars(e,t){try{if(d.isTokenExpired(t))throw new c.Notice("Google calendar token has expired, please reconnect in settings"),new Error("Token expired");return(await(0,c.requestUrl)({url:`${this.BASE_URL}/users/me/calendarList`,method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}})).json.items||[]}catch(n){throw console.error("Error fetching calendars:",n),new c.Notice("Failed to fetch calendars"),n}}static async syncCalendar(e,t){try{if(d.isTokenExpired(t))throw new c.Notice("Google calendar token has expired, please reconnect in settings"),new Error("Token expired");new c.Notice("Syncing calendar");let n=new Date().toISOString(),i=new Date(Date.now()+30*24*60*60*1e3).toISOString(),r=await this.fetchEvents(e,"primary",void 0,n,i);new c.Notice(`Synced ${r.length} events`);return}catch(n){throw console.error("Error syncing calendar:",n),new c.Notice("Failed to sync calendar"),n}}};m.BASE_URL="https://www.googleapis.com/calendar/v3";var T=require("obsidian");var y=class{static renderCallbackUrlSetting(e){new T.Setting(e).setName("Callback URL").setDesc("Use this URL when configuring your Google OAuth application.").addText(t=>t.setValue(C).setDisabled(!0)).addButton(t=>t.setButtonText("Copy").onClick(async()=>{await navigator.clipboard.writeText(C),new T.Notice("Callback URL copied to clipboard.")}))}static renderClientIdSetting(e,t,n){new T.Setting(e).setName("Client ID").addText(i=>i.setPlaceholder("123456789-abcdefg.apps.googleusercontent.com").setValue(t).onChange(async r=>{let o=r.trim();await n(o)}))}static renderTokenExpirySetting(e,t,n){new T.Setting(e).setName("Token expiry").setDesc("How long before the access token expires and requires re-authentication").addDropdown(i=>{Object.entries(R).forEach(([r,o])=>{i.addOption(r,o)}),i.setValue(t).onChange(async r=>{await n(r)})})}static renderTokenStatus(e,t){let n=d.getTimeRemaining(t),i=d.isTokenExpired(t),r=d.needsRefreshSoon(t),o;t?i?o="Token expired":r?o=`Token expires in ${n}`:o=`Token valid for ${n}`:o="Token valid: unlimited",new T.Setting(e).setName("Token status").setDesc(o)}static renderAccountSetting(e,t,n,i,r,o){let s=new T.Setting(e).setName("Account").setDesc(t?"Connected":"Not connected");t?(s.addButton(a=>a.setButtonText("Sync calendar").onClick(async()=>{await o()})),s.addButton(a=>a.setWarning().setButtonText("Disconnect").onClick(async()=>{await r()}))):!n||n===""?s.setDesc("Please set client ID first"):s.addButton(a=>a.setCta().setButtonText("Connect to google").onClick(()=>{i(n)}))}};var _={...I},P=class extends w.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),new w.Setting(e).setName("Pick calendar event").setHeading();let t=e.createDiv({cls:"pmc-intro-section"});new w.Setting(t).setName("How to use").setHeading();let n=t.createEl("ul",{cls:"pmc-usage-list"}),i=n.createEl("li");i.appendText("Type "),i.createEl("code",{text:":"}),i.appendText(" in your note to trigger the calendar event picker");let r=n.createEl("li");r.appendText("Type "),r.createEl("code",{text:":meeting"}),r.appendText(" to search and filter events containing 'meeting'"),n.createEl("li").appendText("Select an event from the list to insert it as a link in your note");let s=n.createEl("li");s.appendText("Choose "),s.createEl("strong",{text:"Create new event"}),s.appendText(" to create a new calendar event"),new w.Setting(e).setName("Setup and configuration").setHeading(),y.renderCallbackUrlSetting(e),y.renderClientIdSetting(e,this.plugin.settings.clientId,async a=>{this.plugin.settings.clientId=a,await this.plugin.saveSettings(),this.display()}),y.renderTokenExpirySetting(e,this.plugin.settings.tokenExpiry,async a=>{this.plugin.settings.tokenExpiry=a,this.plugin.settings.tokenExpiryDate=d.calculateExpiryDate(a),await this.plugin.saveSettings(),this.display()}),new w.Setting(e).setName("Suggestion time range").setDesc('Time duration to fetch calendar events for suggestions (e.g., "90 days"). Events from this many days in the past and future will be considered.').addText(a=>a.setPlaceholder("90 days").setValue(String(this.plugin.settings.timeRange)).onChange(async l=>{this.plugin.settings.timeRange=Number(l),await this.plugin.saveSettings()})),this.plugin.settings.accessToken&&y.renderTokenStatus(e,this.plugin.settings.tokenExpiryDate),y.renderAccountSetting(e,!!this.plugin.settings.accessToken,this.plugin.settings.clientId,a=>{E.initiateOAuthFlow(a)},async()=>{this.plugin.settings.accessToken="",this.plugin.settings.tokenExpiryDate=void 0,await this.plugin.saveSettings(),this.display(),E.disconnect()},async()=>{await m.syncCalendar(this.plugin.settings.accessToken,this.plugin.settings.tokenExpiryDate)})}};var S=require("obsidian");var b=require("obsidian");var h=class{static async deriveKey(e,t){let n=new TextEncoder,i=await crypto.subtle.importKey("raw",n.encode(e),{name:"PBKDF2"},!1,["deriveKey"]);return await crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},i,{name:this.ALGORITHM,length:this.KEY_LENGTH},!1,["encrypt","decrypt"])}static getVaultPassphrase(e){return`${e}-pmc-plugin-secret-v1`}static async encrypt(e,t){if(!e)return"";try{let n=crypto.getRandomValues(new Uint8Array(this.SALT_LENGTH)),i=crypto.getRandomValues(new Uint8Array(this.IV_LENGTH)),r=this.getVaultPassphrase(t),o=await this.deriveKey(r,n),a=new TextEncoder().encode(e),l=await crypto.subtle.encrypt({name:this.ALGORITHM,iv:i},o,a),u=new Uint8Array(n.length+i.length+l.byteLength);return u.set(n,0),u.set(i,n.length),u.set(new Uint8Array(l),n.length+i.length),this.arrayBufferToBase64(u)}catch(n){throw console.error("Encryption error:",n),new Error("Failed to encrypt data")}}static async decrypt(e,t){if(!e)return"";try{let n=this.base64ToArrayBuffer(e),i=n.slice(0,this.SALT_LENGTH),r=n.slice(this.SALT_LENGTH,this.SALT_LENGTH+this.IV_LENGTH),o=n.slice(this.SALT_LENGTH+this.IV_LENGTH),s=this.getVaultPassphrase(t),a=await this.deriveKey(s,i),l=await crypto.subtle.decrypt({name:this.ALGORITHM,iv:r},a,o);return new TextDecoder().decode(l)}catch(n){throw console.error("Decryption error:",n),new Error("Failed to decrypt data")}}static arrayBufferToBase64(e){let t="",n=e.byteLength;for(let i=0;i<n;i++){let r=e[i];r!==void 0&&(t+=String.fromCharCode(r))}return btoa(t)}static base64ToArrayBuffer(e){let t=atob(e),n=t.length,i=new Uint8Array(n);for(let r=0;r<n;r++)i[r]=t.charCodeAt(r);return i}static isEncrypted(e){if(!e)return!1;let t=Math.ceil((this.SALT_LENGTH+this.IV_LENGTH+16)*4/3),n=/^[A-Za-z0-9+/]+=*$/;return e.length>=t&&n.test(e)}};h.ALGORITHM="AES-GCM",h.KEY_LENGTH=256,h.IV_LENGTH=12,h.SALT_LENGTH=16;var g=require("obsidian");var D=class extends g.Modal{constructor(e,t,n,i){super(e),this.plugin=t,this.initialTitle=n,this.onSubmit=i,this.title=n||"",this.isAllDay=!1,this.description="";let r=new Date;this.date=r.toISOString().split("T")[0]||"";let o=(r.getHours()+1)%24,s=(r.getHours()+2)%24;this.startTime=`${String(o).padStart(2,"0")}:00`,this.endTime=`${String(s).padStart(2,"0")}:00`}onOpen(){let{contentEl:e}=this;e.empty(),new g.Setting(e).setName("Create calendar event").setHeading(),new g.Setting(e).setName("Event title").setDesc("Name of the event").addText(s=>s.setPlaceholder("Team meeting").setValue(this.title).onChange(a=>{this.title=a})),new g.Setting(e).setName("Date").setDesc("Date of the event").addText(s=>{s.setPlaceholder("Select date").setValue(this.date).onChange(a=>{this.date=a}),s.inputEl.type="date"}),new g.Setting(e).setName("All-day event").setDesc("Toggle for all-day events").addToggle(s=>s.setValue(this.isAllDay).onChange(a=>{this.isAllDay=a,e.querySelectorAll(".time-setting").forEach(u=>{a?u.addClass("is-hidden"):u.removeClass("is-hidden")})})),new g.Setting(e).setName("Start time").setDesc("Event start time").addText(s=>{s.setPlaceholder("09:00").setValue(this.startTime).onChange(a=>{this.startTime=a}),s.inputEl.type="time"}).settingEl.addClass("time-setting"),new g.Setting(e).setName("End time").setDesc("Event end time").addText(s=>{s.setPlaceholder("10:00").setValue(this.endTime).onChange(a=>{this.endTime=a}),s.inputEl.type="time"}).settingEl.addClass("time-setting"),new g.Setting(e).setName("Description").setDesc("Additional details (optional)").addTextArea(s=>{s.setPlaceholder("Meeting agenda, notes, etc.").setValue(this.description).onChange(a=>{this.description=a}),s.inputEl.rows=4});let i=e.createDiv({cls:"modal-button-container"});i.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{this.close()}),i.createEl("button",{text:"Create event",cls:"mod-cta"}).addEventListener("click",()=>{this.createEvent()})}async createEvent(){if(!this.title.trim()){new g.Notice("Event title is required");return}if(!this.date){new g.Notice("Event date is required");return}if(!this.isAllDay&&(!this.startTime||!this.endTime)){new g.Notice("Start and end times are required");return}if(!this.plugin.settings.accessToken){new g.Notice("Not authenticated, please connect your google account in settings");return}if(d.isTokenExpired(this.plugin.settings.tokenExpiryDate)){new g.Notice("Access token has expired, please reconnect your google account in settings");return}try{let e={summary:this.title.trim(),description:this.description.trim()||void 0};if(this.isAllDay)e.start={date:this.date,timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone},e.end={date:this.date,timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone};else{let i=`${this.date}T${this.startTime}:00`,r=`${this.date}T${this.endTime}:00`;e.start={dateTime:i,timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone},e.end={dateTime:r,timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone}}let t=await m.createEvent(this.plugin.settings.accessToken,e,"primary",this.plugin.settings.tokenExpiryDate),n=t.htmlLink||`https://calendar.google.com/calendar/event?eid=${encodeURIComponent(t.id)}`;new g.Notice(`Event "${this.title}" created successfully`),this.onSubmit({title:this.title,link:n}),this.close()}catch(e){let t=e instanceof Error?e.message:"Unknown error";new g.Notice(`Failed to create event: ${t}`)}}onClose(){let{contentEl:e}=this;e.empty()}};var L=class extends b.EditorSuggest{constructor(t,n){super(t);this.cachedEvents=[];this.lastFetchTime=0;this.CACHE_DURATION=5*60*1e3;this.plugin=n}onTrigger(t,n,i){let s=n.getLine(t.line).substring(0,t.ch).match(/:([\w\s]*)$/);if(s){let a=s[1]||"",l=t.ch-s[0].length+1;return{start:{line:t.line,ch:l},end:t,query:a}}return null}async fetchEventsWithCache(t){let n=Date.now();if(n-this.lastFetchTime>this.CACHE_DURATION||this.cachedEvents.length===0)try{let r=new Date(Date.now()-864e5).toISOString(),o=new Date(Date.now()+this.plugin.settings.timeRange*24*60*60*1e3).toISOString();this.cachedEvents=await m.fetchEvents(this.plugin.settings.accessToken,"primary",void 0,r,o,250,this.plugin.settings.tokenExpiryDate),this.lastFetchTime=n}catch(r){return console.error("Error fetching events:",r),[]}return this.cachedEvents}filterEvents(t,n){if(!n||n.trim()==="")return t;let i=n.toLowerCase().trim();return t.filter(r=>{var o,s,a,l;return!!((o=r.summary)!=null&&o.toLowerCase().includes(i)||(s=r.description)!=null&&s.toLowerCase().includes(i)||(a=r.location)!=null&&a.toLowerCase().includes(i)||(l=r.attendees)!=null&&l.some(u=>{var x,v;return((x=u.email)==null?void 0:x.toLowerCase().includes(i))||((v=u.displayName)==null?void 0:v.toLowerCase().includes(i))}))})}async getSuggestions(t){if(this.plugin.settings.accessToken==="")return new b.Notice("Please connect to google calendar first"),[];let n=(t.query||"").trim();try{let i=await this.fetchEventsWithCache(),r=this.filterEvents(i,n),o=[];return o.push(...r.map(s=>({event:s,summary:s.summary||s.description||"Untitled event"}))),[{isCreate:!0,summary:"Create new event"},...o]}catch(i){return console.error("Error getting suggestions:",i),[]}}renderSuggestion(t,n){n.empty();let i=n.createDiv({cls:"gcal-suggestion-container"});if(t.isCreate)i.addClass("create-new"),i.createEl("span",{text:t.summary});else if(t.event){let r=t.event,o=i.createDiv({cls:"gcal-suggestion-left"});o.createEl("div",{text:r.summary||"Untitled event",cls:"gcal-event-title"}),r.location&&o.createEl("div",{text:r.location,cls:"gcal-event-location"});let s=i.createDiv({cls:"gcal-suggestion-right"});try{let a=new Date(r.start.dateTime||r.start.date||""),l=new Date,u=a.toDateString()===l.toDateString(),x=a.toDateString()===new Date(l.getTime()+864e5).toDateString(),v="";u?v="Today":x?v="Tomorrow":v=a.toLocaleDateString([],{month:"short",day:"numeric",year:a.getFullYear()!==l.getFullYear()?"numeric":void 0});let N="";r.start.dateTime?N=a.toLocaleTimeString([],{hour:"numeric",minute:"2-digit",hour12:!0}):N="All day",s.createEl("div",{text:v,cls:"gcal-event-date"}),s.createEl("div",{text:N,cls:"gcal-event-time"}),(r.hangoutLink||r.conferenceData)&&s.createEl("div",{text:"Video",cls:"gcal-event-conference"})}catch(a){console.error("Error formatting date:",a),s.createEl("small",{text:"Invalid date",attr:{style:"color: var(--text-error);"}})}}}selectSuggestion(t,n){if(!this.context){console.error("No context available");return}if(t.isCreate){let i=this.context.editor,r={...this.context.start},o={...this.context.end},s=this.context.query;new D(this.app,this.plugin,s,a=>{let l=`[${a.title}](${a.link})`;i.replaceRange(l,r,o),this.clearCache()}).open()}else if(t.event){let i=t.event,r=i.htmlLink||`https://calendar.google.com/calendar/event?eid=${encodeURIComponent(i.id)}`,s=`[${i.summary||"Untitled Event"}](${r})`;this.context.editor.replaceRange(s,this.context.start,this.context.end)}}clearCache(){this.cachedEvents=[],this.lastFetchTime=0}};var f=class{static async encryptSettings(e,t){let n={...e};for(let i of this.ENCRYPTED_FIELDS){let r=n[i];if(r&&typeof r=="string"&&r.length>0&&!this.isEncrypted(r))try{let o=await h.encrypt(r,t);n[i]=this.ENCRYPTION_PREFIX+o}catch(o){console.error(`Failed to encrypt field ${String(i)}:`,o)}}return n}static async decryptSettings(e,t){let n={...e};for(let i of this.ENCRYPTED_FIELDS){let r=n[i];if(r&&typeof r=="string"&&this.isEncrypted(r))try{let o=r.substring(this.ENCRYPTION_PREFIX.length),s=await h.decrypt(o,t);n[i]=s}catch(o){console.error(`Failed to decrypt field ${String(i)}:`,o),n[i]=""}}return n}static isEncrypted(e){return e.startsWith(this.ENCRYPTION_PREFIX)}static async migrateToEncrypted(e,t){let n=!1;for(let i of this.ENCRYPTED_FIELDS){let r=e[i];if(r&&typeof r=="string"&&r.length>0&&!this.isEncrypted(r)){n=!0;break}}return n?{settings:await this.encryptSettings(e,t),migrated:!0}:{settings:e,migrated:!1}}};f.ENCRYPTED_FIELDS=["clientId","accessToken"],f.ENCRYPTION_PREFIX="enc:";var A=class extends S.Plugin{constructor(){super(...arguments);this.settingTab=null;this.editorSuggestion=null}async onload(){await this.loadSettings(),this.settingTab=new P(this.app,this),this.addSettingTab(this.settingTab),this.registerObsidianProtocolHandler("pick-meeting-token",async t=>{var i;let n=t.access_token;if(n)try{this.settings.accessToken=n;let r=this.settings.tokenExpiry||"unlimited";this.settings.tokenExpiryDate=d.calculateExpiryDate(r),await this.saveSettings(),(i=this.settingTab)==null||i.display(),new S.Notice("Google calendar connected")}catch(r){console.error("Failed to save access token:",r),new S.Notice("Failed to secure access token")}else new S.Notice(`Connection failed: ${t.error||"No token found in response"}`)}),this.editorSuggestion=new L(this.app,this),this.registerEditorSuggest(this.editorSuggestion)}onunload(){}async loadSettings(){let t=await this.loadData(),n=Object.assign({},_,t),i=this.app.vault.getName();this.settings=await f.decryptSettings(n,i);let{settings:r,migrated:o}=await f.migrateToEncrypted(this.settings,i);o&&(this.settings=r,await this.saveSettings())}async saveSettings(){let t=this.app.vault.getName(),n=await f.encryptSettings(this.settings,t);await this.saveData(n)}};
