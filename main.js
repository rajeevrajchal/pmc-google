/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var L=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var H=Object.prototype.hasOwnProperty;var B=(g,t)=>{for(var e in t)L(g,e,{get:t[e],enumerable:!0})},F=(g,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of $(t))!H.call(g,s)&&s!==e&&L(g,s,{get:()=>t[s],enumerable:!(n=M(t,s))||n.enumerable});return g};var V=g=>F(L({},"__esModule",{value:!0}),g);var j={};B(j,{default:()=>P});module.exports=V(j);var v=require("obsidian");var _={clientId:"",clientSecret:"",accessToken:"",refreshToken:"",tokenExpiry:"1week",tokenExpiryDate:void 0,accessTokenExpiresAt:void 0,timeRange:90,encryptionEnabled:!0},G={"1week":"1 week","1month":"1 month","3months":"3 months","6months":"6 months",unlimited:"Unlimited (until manually disconnected)"},x="https://rajeevrajchal.github.io/pmc-google/oauth-callback",R="https://your-server.com/api/token/exchange",N="https://your-server.com/api/token/refresh";var S=require("obsidian");var E=class{static initiateOAuthFlow(t){if(!t||t.trim()===""){new S.Notice("Please configure client ID first");return}let e=this.buildAuthUrl(t);new S.Notice("Opening Google authentication..."),window.open(e,"_blank")}static buildAuthUrl(t){let e=new URLSearchParams({client_id:t,redirect_uri:x,response_type:"code",scope:this.SCOPES.join(" "),access_type:"offline",prompt:"consent"});return`${this.OAUTH_URL}?${e.toString()}`}static async exchangeCodeForTokens(t,e,n){try{let i=(await(0,S.requestUrl)({url:R,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:t,client_id:e,client_secret:n,redirect_uri:x})})).json;if(!i.refresh_token)throw new Error("No refresh token received. User may need to revoke access and reconnect.");return{accessToken:i.access_token,refreshToken:i.refresh_token,expiresIn:i.expires_in}}catch(s){throw console.error("Token exchange failed:",s),new Error("Failed to exchange authorization code for tokens")}}static disconnect(){new S.Notice("Disconnected from Google Calendar")}};E.OAUTH_URL="https://accounts.google.com/o/oauth2/v2/auth",E.SCOPES=["https://www.googleapis.com/auth/calendar.readonly","https://www.googleapis.com/auth/calendar.events"];var c=require("obsidian");var I=require("obsidian");var l=class{static calculateExpiryDate(t){if(t==="unlimited")return;let e=Date.now(),n=24*60*60*1e3;switch(t){case"1week":return e+7*n;case"1month":return e+30*n;case"3months":return e+90*n;case"6months":return e+180*n;default:return}}static isTokenExpired(t){return t?Date.now()>=t:!1}static getTimeRemaining(t){if(!t)return"Unlimited";let e=t-Date.now();if(e<=0)return"Expired";let n=Math.floor(e/(24*60*60*1e3)),s=Math.floor(e%(24*60*60*1e3)/(60*60*1e3)),i=Math.floor(e%(60*60*1e3)/(60*1e3));return n>0?`${n} day${n!==1?"s":""}`:s>0?`${s} hour${s!==1?"s":""}`:`${i} minute${i!==1?"s":""}`}static needsRefreshSoon(t){if(!t)return!1;let e=24*60*60*1e3,n=t-Date.now();return n>0&&n<e}static formatExpiryDate(t){return t?new Date(t).toLocaleDateString(void 0,{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Never"}static needsAccessTokenRefresh(t){if(!t)return!1;let e=5*60*1e3;return t-Date.now()<=e}static async refreshAccessToken(t,e,n){try{let i=(await(0,I.requestUrl)({url:N,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:t,client_id:e,client_secret:n})})).json,a=Date.now()+i.expires_in*1e3;return{accessToken:i.access_token,expiresAt:a}}catch(s){throw console.error("Failed to refresh access token:",s),new Error("Failed to refresh access token")}}static async validateAccessToken(t){try{return(await(0,I.requestUrl)({url:"https://www.googleapis.com/oauth2/v1/tokeninfo",method:"GET",headers:{Authorization:`Bearer ${t}`}})).status===200}catch(e){return!1}}};var T=class{static async fetchEvents(t,e="primary",n,s,i,a=250,r){try{if(l.isTokenExpired(r))throw new c.Notice("\u26A0\uFE0F Google Calendar token has expired. Please reconnect in settings."),new Error("Token expired");let o={singleEvents:"true",orderBy:"startTime",maxResults:a.toString()};s&&(o.timeMin=s),i&&(o.timeMax=i),n&&n.trim()!==""&&(o.q=n);let p=new URLSearchParams(o).toString();return(await(0,c.requestUrl)({url:`${this.BASE_URL}/calendars/${e}/events?${p}`,method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}})).json.items||[]}catch(o){throw console.error("Error fetching calendar events:",o),new c.Notice("Failed to fetch calendar events"),o}}static async createEvent(t,e,n="primary",s){try{if(l.isTokenExpired(s))throw new c.Notice("\u26A0\uFE0F Google Calendar token has expired. Please reconnect in settings."),new Error("Token expired");let a=(await(0,c.requestUrl)({url:`${this.BASE_URL}/calendars/${n}/events`,method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(e)})).json;return new c.Notice("Event created successfully"),a}catch(i){throw console.error("Error creating calendar event:",i),new c.Notice("Failed to create calendar event"),i}}static async updateEvent(t,e,n,s="primary",i){try{if(l.isTokenExpired(i))throw new c.Notice("\u26A0\uFE0F Google Calendar token has expired. Please reconnect in settings."),new Error("Token expired");let r=(await(0,c.requestUrl)({url:`${this.BASE_URL}/calendars/${s}/events/${e}`,method:"PUT",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(n)})).json;return new c.Notice("Event updated successfully"),r}catch(a){throw console.error("Error updating calendar event:",a),new c.Notice("Failed to update calendar event"),a}}static async deleteEvent(t,e,n="primary",s){try{if(l.isTokenExpired(s))throw new c.Notice("\u26A0\uFE0F Google Calendar token has expired. Please reconnect in settings."),new Error("Token expired");await(0,c.requestUrl)({url:`${this.BASE_URL}/calendars/${n}/events/${e}`,method:"DELETE",headers:{Authorization:`Bearer ${t}`}}),new c.Notice("Event deleted successfully")}catch(i){throw console.error("Error deleting calendar event:",i),new c.Notice("Failed to delete calendar event"),i}}static async listCalendars(t,e){try{if(l.isTokenExpired(e))throw new c.Notice("\u26A0\uFE0F Google Calendar token has expired. Please reconnect in settings."),new Error("Token expired");return(await(0,c.requestUrl)({url:`${this.BASE_URL}/users/me/calendarList`,method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}})).json.items||[]}catch(n){throw console.error("Error fetching calendars:",n),new c.Notice("Failed to fetch calendars"),n}}static async syncCalendar(t,e){try{if(l.isTokenExpired(e))throw new c.Notice("\u26A0\uFE0F Google Calendar token has expired. Please reconnect in settings."),new Error("Token expired");new c.Notice("Syncing calendar...");let n=new Date().toISOString(),s=new Date(Date.now()+30*24*60*60*1e3).toISOString(),i=await this.fetchEvents(t,"primary",void 0,n,s);new c.Notice(`Synced ${i.length} events`);return}catch(n){throw console.error("Error syncing calendar:",n),new c.Notice("Failed to sync calendar"),n}}};T.BASE_URL="https://www.googleapis.com/calendar/v3";var f=require("obsidian");var m=class{static renderSecurityNotice(t){let e=t.createDiv({cls:"pmc-security-notice"});new f.Setting(e).setName("Security & privacy").setHeading();let n=e.createDiv({cls:"setting-item-description"});n.style.marginBottom="15px",n.style.padding="10px",n.style.background="var(--background-modifier-message)",n.style.borderRadius="4px",n.createEl("p",{text:"\u{1F510} Your tokens are encrypted and stored locally in your vault."}),n.createEl("p",{text:"\u2139\uFE0F This plugin uses OAuth refresh tokens for improved security. Access tokens expire after 1 hour and are automatically refreshed."});let s=n.createEl("p");s.createEl("strong",{text:"Important: "}),s.appendText("While tokens are encrypted, any plugin running in Obsidian could potentially access them. Only install trusted plugins.")}static renderSetupGuide(t){let e=t.createDiv({cls:"pmc-setup-guide"});new f.Setting(e).setName("Setup guide").setHeading();let n=e.createEl("ol"),s=n.createEl("li");s.createEl("strong",{text:"Create a google cloud project:"});let i=s.createEl("ul"),a=i.createEl("li");a.appendText("Go to "),a.createEl("a",{text:"Google Cloud Console",href:"https://console.cloud.google.com/",attr:{target:"_blank"}}),i.createEl("li",{text:'Click "Select a project" \u2192 "New project"'}),i.createEl("li",{text:'Give it a name (e.g., "Obsidian PMC plugin") and click "Create"'});let r=n.createEl("li");r.createEl("strong",{text:"Enable Google Calendar API:"});let o=r.createEl("ul");o.createEl("li",{text:'In the sidebar, go to "APIs & services" \u2192 "Library"'}),o.createEl("li",{text:'Search for "Google Calendar API"'}),o.createEl("li",{text:'Click on it and press "Enable"'});let p=n.createEl("li");p.createEl("strong",{text:"Create OAuth 2.0 credentials:"});let u=p.createEl("ul");u.createEl("li",{text:'Go to "APIs & services" \u2192 "Credentials"'}),u.createEl("li",{text:'Click "Create credentials" \u2192 "OAuth client ID"'}),u.createEl("li",{text:"If prompted, configure the OAuth consent screen first"}),u.createEl("li",{text:'Select "Web application" as the application type'}),u.createEl("li",{text:"Add this authorized redirect URI: "}).createEl("code",{text:x}),u.createEl("li",{text:'Click "Create" and copy your client ID'}),n.createEl("li").createEl("strong",{text:"Paste the client ID below and click Connect"})}static renderCallbackUrlSetting(t){new f.Setting(t).setName("OAuth callback URL").setDesc("Use this URL when configuring your Google OAuth application").addText(e=>e.setValue(x).setDisabled(!0)).addButton(e=>e.setButtonText("Copy").onClick(async()=>{await navigator.clipboard.writeText(x),new f.Notice("Callback URL copied to clipboard!")}))}static renderClientIdSetting(t,e,n){new f.Setting(t).setName("Client ID").setDesc("OAuth 2.0 client ID from Google Cloud Console").addText(s=>s.setPlaceholder("123456789-abcdefg.apps.googleusercontent.com").setValue(e).onChange(async i=>{await n(i.trim())}))}static renderClientSecretSetting(t,e,n){new f.Setting(t).setName("Client secret").setDesc("OAuth 2.0 client secret from Google Cloud Console (required for refresh tokens)").addText(s=>{s.setPlaceholder("GOCSPX-xxxxxxxxxxxxxxxxxxxxx").setValue(e?"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022":"").onChange(async i=>{i&&i!=="\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022"&&await n(i.trim())}),s.inputEl.type="password"})}static renderTokenExpirySetting(t,e,n){new f.Setting(t).setName("Token Expiry").setDesc("How long before the access token expires and requires re-authentication").addDropdown(s=>{Object.entries(G).forEach(([i,a])=>{s.addOption(i,a)}),s.setValue(e).onChange(async i=>{await n(i)})})}static renderTokenStatus(t,e){let n=l.getTimeRemaining(e),s=l.isTokenExpired(e),i=l.needsRefreshSoon(e),a;e?s?a="\u26A0\uFE0F Token expired":i?a=`\u26A0\uFE0F Token expires in ${n}`:a=`\u2705 Token valid for ${n}`:a="\u2705 Token valid: Unlimited",new f.Setting(t).setName("Token status").setDesc(a)}static renderAccountSetting(t,e,n,s,i,a){let r=new f.Setting(t).setName("Account").setDesc(e?"\u2705 Connected":"\u274C Not Connected");e?(r.addButton(o=>o.setButtonText("Sync calendar").onClick(async()=>{await a()})),r.addButton(o=>o.setWarning().setButtonText("Disconnect").onClick(async()=>{await i()}))):!n||n===""?r.setDesc("\u26A0\uFE0F Please set client ID first"):r.addButton(o=>o.setCta().setButtonText("Connect to Google").onClick(()=>{s()}))}};var U={..._},C=class extends v.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),new v.Setting(t).setName("Pick calendar event").setHeading();let e=t.createDiv({cls:"pmc-intro-section"});new v.Setting(e).setName("How to use").setHeading();let n=e.createEl("ul",{cls:"pmc-usage-list"}),s=n.createEl("li");s.appendText("Type "),s.createEl("code",{text:":"}),s.appendText(" in your note to trigger the calendar event picker");let i=n.createEl("li");i.appendText("Type "),i.createEl("code",{text:":meeting"}),i.appendText(" to search and filter events containing 'meeting'"),n.createEl("li").appendText("Select an event from the list to insert it as a link in your note");let r=n.createEl("li");r.appendText("Choose "),r.createEl("strong",{text:"+ Create new event"}),r.appendText(" to create a new calendar event"),new v.Setting(t).setName("Setup & configuration").setHeading(),m.renderSecurityNotice(t),m.renderSetupGuide(t),m.renderCallbackUrlSetting(t),m.renderClientIdSetting(t,this.plugin.settings.clientId,async o=>{this.plugin.settings.clientId=o,await this.plugin.saveSettings(),this.display()}),m.renderClientSecretSetting(t,this.plugin.settings.clientSecret||"",async o=>{this.plugin.settings.clientSecret=o,await this.plugin.saveSettings(),this.display()}),m.renderTokenExpirySetting(t,this.plugin.settings.tokenExpiry,async o=>{this.plugin.settings.tokenExpiry=o,this.plugin.settings.tokenExpiryDate=l.calculateExpiryDate(o),await this.plugin.saveSettings(),this.display()}),new v.Setting(t).setName("Suggestion time range").setDesc('Time duration to fetch calendar events for suggestions (e.g., "90 days"). Events from this many days in the past and future will be considered.').addText(o=>o.setPlaceholder("90 days").setValue(String(this.plugin.settings.timeRange)).onChange(async p=>{this.plugin.settings.timeRange=Number(p),await this.plugin.saveSettings()})),this.plugin.settings.accessToken&&m.renderTokenStatus(t,this.plugin.settings.tokenExpiryDate),m.renderAccountSetting(t,!!this.plugin.settings.accessToken,this.plugin.settings.clientId,()=>{E.initiateOAuthFlow(this.plugin.settings.clientId)},async()=>{this.plugin.settings.accessToken="",this.plugin.settings.tokenExpiryDate=void 0,await this.plugin.saveSettings(),this.display(),E.disconnect()},async()=>{await T.syncCalendar(this.plugin.settings.accessToken,this.plugin.settings.tokenExpiryDate)})}};var y=require("obsidian");var D=require("obsidian");var d=require("obsidian");var b=class extends d.Modal{constructor(t,e,n,s){super(t),this.plugin=e,this.initialTitle=n,this.onSubmit=s,this.title=n||"",this.isAllDay=!1,this.description="";let i=new Date;this.date=i.toISOString().split("T")[0]||"";let a=(i.getHours()+1)%24,r=(i.getHours()+2)%24;this.startTime=`${String(a).padStart(2,"0")}:00`,this.endTime=`${String(r).padStart(2,"0")}:00`}onOpen(){let{contentEl:t}=this;t.empty(),new d.Setting(t).setName("Create calendar event").setHeading(),new d.Setting(t).setName("Event title").setDesc("Name of the event").addText(r=>r.setPlaceholder("Team Meeting").setValue(this.title).onChange(o=>{this.title=o})),new d.Setting(t).setName("Date").setDesc("Event date").addText(r=>{r.setPlaceholder("YYYY-MM-DD").setValue(this.date).onChange(o=>{this.date=o}),r.inputEl.type="date"}),new d.Setting(t).setName("All-day event").setDesc("Toggle for all-day events").addToggle(r=>r.setValue(this.isAllDay).onChange(o=>{this.isAllDay=o,t.querySelectorAll(".time-setting").forEach(u=>{o?u.addClass("is-hidden"):u.removeClass("is-hidden")})})),new d.Setting(t).setName("Start time").setDesc("Event start time").addText(r=>{r.setPlaceholder("09:00").setValue(this.startTime).onChange(o=>{this.startTime=o}),r.inputEl.type="time"}).settingEl.addClass("time-setting"),new d.Setting(t).setName("End time").setDesc("Event end time").addText(r=>{r.setPlaceholder("10:00").setValue(this.endTime).onChange(o=>{this.endTime=o}),r.inputEl.type="time"}).settingEl.addClass("time-setting"),new d.Setting(t).setName("Description").setDesc("Additional details (optional)").addTextArea(r=>{r.setPlaceholder("Meeting agenda, notes, etc.").setValue(this.description).onChange(o=>{this.description=o}),r.inputEl.rows=4});let s=t.createDiv({cls:"modal-button-container"});s.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{this.close()}),s.createEl("button",{text:"Create event",cls:"mod-cta"}).addEventListener("click",()=>{this.createEvent()})}async createEvent(){if(!this.title.trim()){new d.Notice("\u274C Event title is required");return}if(!this.date){new d.Notice("\u274C Event date is required");return}if(!this.isAllDay&&(!this.startTime||!this.endTime)){new d.Notice("\u274C Start and end times are required");return}if(!this.plugin.settings.accessToken){new d.Notice("\u274C Not authenticated. Please connect your Google account in settings.");return}if(l.isTokenExpired(this.plugin.settings.tokenExpiryDate)){new d.Notice("\u274C Access token has expired. Please reconnect your Google account in settings.");return}try{let t={summary:this.title.trim(),description:this.description.trim()||void 0};if(this.isAllDay)t.start={date:this.date,timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone},t.end={date:this.date,timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone};else{let i=`${this.date}T${this.startTime}:00`,a=`${this.date}T${this.endTime}:00`;t.start={dateTime:i,timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone},t.end={dateTime:a,timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone}}let e=await this.plugin.getValidAccessToken(),n=await T.createEvent(e,t,"primary",this.plugin.settings.tokenExpiryDate),s=n.htmlLink||`https://calendar.google.com/calendar/event?eid=${encodeURIComponent(n.id)}`;new d.Notice(`\u2705 Event "${this.title}" created successfully!`),this.onSubmit({title:this.title,link:s}),this.close()}catch(t){let e=t instanceof Error?t.message:"Unknown error";new d.Notice(`\u274C Failed to create event: ${e}`)}}onClose(){let{contentEl:t}=this;t.empty()}};var A=class extends D.EditorSuggest{constructor(e,n){super(e);this.cachedEvents=[];this.lastFetchTime=0;this.CACHE_DURATION=5*60*1e3;this.plugin=n}onTrigger(e,n,s){let r=n.getLine(e.line).substring(0,e.ch).match(/:([\w\s]*)$/);if(r){let o=r[1]||"",p=e.ch-r[0].length+1;return{start:{line:e.line,ch:p},end:e,query:o}}return null}async fetchEventsWithCache(e){let n=Date.now();if(n-this.lastFetchTime>this.CACHE_DURATION||this.cachedEvents.length===0)try{let i=new Date(Date.now()-864e5).toISOString(),a=new Date(Date.now()+this.plugin.settings.timeRange*24*60*60*1e3).toISOString(),r=await this.plugin.getValidAccessToken();this.cachedEvents=await T.fetchEvents(r,"primary",void 0,i,a,250,this.plugin.settings.tokenExpiryDate),this.lastFetchTime=n}catch(i){return console.error("Error fetching events:",i),[]}return this.cachedEvents}filterEvents(e,n){if(!n||n.trim()==="")return e;let s=n.toLowerCase().trim();return e.filter(i=>{var a,r,o,p;return!!((a=i.summary)!=null&&a.toLowerCase().includes(s)||(r=i.description)!=null&&r.toLowerCase().includes(s)||(o=i.location)!=null&&o.toLowerCase().includes(s)||(p=i.attendees)!=null&&p.some(u=>{var k,w;return((k=u.email)==null?void 0:k.toLowerCase().includes(s))||((w=u.displayName)==null?void 0:w.toLowerCase().includes(s))}))})}async getSuggestions(e){if(this.plugin.settings.accessToken==="")return new D.Notice("Please connect to Google Calendar first"),[];let n=(e.query||"").trim();try{let s=await this.fetchEventsWithCache(),i=this.filterEvents(s,n),a=[];return a.push(...i.map(r=>({event:r,summary:r.summary||r.description||"Untitled Event"}))),[{isCreate:!0,summary:"+ Create new event"},...a]}catch(s){return console.error("Error getting suggestions:",s),[]}}renderSuggestion(e,n){n.empty();let s=n.createDiv({cls:"gcal-suggestion-container"});if(e.isCreate)s.addClass("create-new"),s.createEl("span",{text:e.summary});else if(e.event){let i=e.event,a=s.createDiv({cls:"gcal-suggestion-left"});a.createEl("div",{text:i.summary||"Untitled event",cls:"gcal-event-title"}),i.location&&a.createEl("div",{text:i.location,cls:"gcal-event-location"});let r=s.createDiv({cls:"gcal-suggestion-right"});try{let o=new Date(i.start.dateTime||i.start.date||""),p=new Date,u=o.toDateString()===p.toDateString(),k=o.toDateString()===new Date(p.getTime()+864e5).toDateString(),w="";u?w="Today":k?w="Tomorrow":w=o.toLocaleDateString([],{month:"short",day:"numeric",year:o.getFullYear()!==p.getFullYear()?"numeric":void 0});let O="";i.start.dateTime?O=o.toLocaleTimeString([],{hour:"numeric",minute:"2-digit",hour12:!0}):O="All day",r.createEl("div",{text:w,cls:"gcal-event-date"}),r.createEl("div",{text:O,cls:"gcal-event-time"}),(i.hangoutLink||i.conferenceData)&&r.createEl("div",{text:"\u{1F3A5} Video",cls:"gcal-event-conference"})}catch(o){console.error("Error formatting date:",o),r.createEl("small",{text:"Invalid date",attr:{style:"color: var(--text-error);"}})}}}selectSuggestion(e,n){if(!this.context){console.error("No context available");return}if(e.isCreate)new b(this.app,this.plugin,this.context.query,s=>{if(this.context){let i=`[${s.title}](${s.link})`;this.context.editor.replaceRange(i,this.context.start,this.context.end)}}).open();else if(e.event){let s=e.event,i=s.htmlLink||`https://calendar.google.com/calendar/event?eid=${encodeURIComponent(s.id)}`,r=`[${s.summary||"Untitled Event"}](${i})`;this.context.editor.replaceRange(r,this.context.start,this.context.end)}}clearCache(){this.cachedEvents=[],this.lastFetchTime=0}};var h=class{static async getEncryptionKey(t){let n=new TextEncoder().encode(t+"obsidian-pmc-plugin-v1"),s=await crypto.subtle.digest("SHA-256",n);return await crypto.subtle.importKey("raw",s,{name:this.ALGORITHM,length:this.KEY_LENGTH},!1,["encrypt","decrypt"])}static async encrypt(t,e){if(!t)return"";try{let s=new TextEncoder().encode(t),i=crypto.getRandomValues(new Uint8Array(this.IV_LENGTH)),a=await this.getEncryptionKey(e),r=await crypto.subtle.encrypt({name:this.ALGORITHM,iv:i},a,s),o=new Uint8Array(i.length+r.byteLength);return o.set(i,0),o.set(new Uint8Array(r),i.length),this.arrayBufferToBase64(o)}catch(n){throw console.error("Encryption failed:",n),new Error("Failed to encrypt token")}}static async decrypt(t,e){if(!t)return"";try{let n=this.base64ToArrayBuffer(t),s=n.slice(0,this.IV_LENGTH),i=n.slice(this.IV_LENGTH),a=await this.getEncryptionKey(e),r=await crypto.subtle.decrypt({name:this.ALGORITHM,iv:s},a,i);return new TextDecoder().decode(r)}catch(n){throw console.error("Decryption failed:",n),new Error("Failed to decrypt token")}}static isEncrypted(t){return t?/^[A-Za-z0-9+/]+=*$/.test(t)&&t.length>50:!1}static arrayBufferToBase64(t){let e="",n=t.byteLength;for(let s=0;s<n;s++){let i=t[s];i!==void 0&&(e+=String.fromCharCode(i))}return btoa(e)}static base64ToArrayBuffer(t){let e=atob(t),n=e.length,s=new Uint8Array(n);for(let i=0;i<n;i++){let a=e.charCodeAt(i);s[i]=a}return s}};h.ALGORITHM="AES-GCM",h.KEY_LENGTH=256,h.IV_LENGTH=12;var P=class extends y.Plugin{constructor(){super(...arguments);this.settingTab=null;this.editorSuggestion=null}async onload(){await this.loadSettings(),this.settingTab=new C(this.app,this),this.addSettingTab(this.settingTab),this.registerObsidianProtocolHandler("pick-meeting-token",async e=>{var n,s;if(e.code)try{if(!this.settings.clientSecret){new y.Notice("\u274C Client secret not configured. Please add it in settings.");return}new y.Notice("Exchanging authorization code for tokens...");let i=await E.exchangeCodeForTokens(e.code,this.settings.clientId,this.settings.clientSecret);this.settings.accessToken=i.accessToken,this.settings.refreshToken=i.refreshToken,this.settings.accessTokenExpiresAt=Date.now()+i.expiresIn*1e3;let a=this.settings.tokenExpiry||"1week";this.settings.tokenExpiryDate=l.calculateExpiryDate(a),await this.saveSettings(),(n=this.settingTab)==null||n.display(),new y.Notice("\u2705 Google Calendar connected!")}catch(i){console.error("Token exchange failed:",i),new y.Notice(`\u274C Connection failed: ${i instanceof Error?i.message:"Unknown error"}`)}else if(e.access_token){this.settings.accessToken=e.access_token;let i=this.settings.tokenExpiry||"1week";this.settings.tokenExpiryDate=l.calculateExpiryDate(i),await this.saveSettings(),(s=this.settingTab)==null||s.display(),new y.Notice("\u2705 Google Calendar connected! (Legacy mode - consider reconnecting for better security)")}else new y.Notice(`\u274C Connection failed: ${e.error||"No authorization code or token found"}`)}),this.editorSuggestion=new A(this.app,this),this.registerEditorSuggest(this.editorSuggestion)}onunload(){}async loadSettings(){let e=await this.loadData();if(this.settings=Object.assign({},U,e),this.settings.encryptionEnabled&&this.settings.accessToken)try{let n=this.getVaultId();h.isEncrypted(this.settings.accessToken)&&(this.settings.accessToken=await h.decrypt(this.settings.accessToken,n)),this.settings.refreshToken&&h.isEncrypted(this.settings.refreshToken)&&(this.settings.refreshToken=await h.decrypt(this.settings.refreshToken,n)),this.settings.clientSecret&&h.isEncrypted(this.settings.clientSecret)&&(this.settings.clientSecret=await h.decrypt(this.settings.clientSecret,n))}catch(n){console.error("Failed to decrypt tokens:",n),new y.Notice("\u26A0\uFE0F Failed to decrypt tokens. You may need to reconnect."),this.settings.accessToken="",this.settings.refreshToken="",this.settings.clientSecret=""}}async saveSettings(){let e={...this.settings};if(this.settings.encryptionEnabled)try{let n=this.getVaultId();e.accessToken&&(e.accessToken=await h.encrypt(e.accessToken,n)),e.refreshToken&&(e.refreshToken=await h.encrypt(e.refreshToken,n)),e.clientSecret&&(e.clientSecret=await h.encrypt(e.clientSecret,n))}catch(n){console.error("Failed to encrypt tokens:",n),new y.Notice("\u26A0\uFE0F Failed to encrypt tokens. Saving unencrypted.")}await this.saveData(e)}getVaultId(){return`${this.app.vault.getName()}-${this.app.vault.adapter.getName()}`}async getValidAccessToken(){if(this.settings.refreshToken&&this.settings.clientSecret&&l.needsAccessTokenRefresh(this.settings.accessTokenExpiresAt))try{let e=await l.refreshAccessToken(this.settings.refreshToken,this.settings.clientId,this.settings.clientSecret);this.settings.accessToken=e.accessToken,this.settings.accessTokenExpiresAt=e.expiresAt,await this.saveSettings(),console.log("Access token refreshed successfully")}catch(e){throw console.error("Failed to refresh access token:",e),new y.Notice("\u26A0\uFE0F Failed to refresh access token. Please reconnect in settings."),e}return this.settings.accessToken}};
